name: Push to Replicate

on:
  push:
    branches:
      - main
      - github-actions

jobs:
  build:
    runs-on: ubuntu-latest-4-cores
    steps:
      - name: Setup llama-2-7b Cog
        uses: replicate/setup-cog@v1.0.2
        with:
          token: ${{ secrets.REPLICATE_API_TOKEN }}

      - name: Check out code
        uses: actions/checkout@v3
        with:
          submodules: "true"

      - name: Install dependencies
        run: pip install replicate pytest

      - name: Select llama-2-7b
        run: make select model=llama-2-7b

      - name: Build llama-2-7b
        run: cog build

      - name: Push to Replicate
        run: |
          cog push r8.im/replicate-internal/ci-llama-2-7b

      - name: run basic prediction tests
        env:
          REPLICATE_API_TOKEN: ${{ secrets.REPLICATE_API_TOKEN }}
        run: make test-ci-predict model=llama-2-7b
